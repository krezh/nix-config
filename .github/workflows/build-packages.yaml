---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Build Packages
on:
  workflow_dispatch:
  workflow_call:
  pull_request:
    branches: ["main"]
    paths: &paths
      - "pkgs/**"
  push:
    branches: ["main"]
    paths: *paths

permissions:
  contents: read
  actions: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true
env:
  CACHE_NAME: krezh

jobs:
  generate-matrix:
    name: Generate Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Nix with caching
        uses: ./.github/actions/setup-nix
        with:
          cachix-cache: ${{ env.CACHE_NAME }}

      - name: Install nix-eval-jobs
        run: |
          nix profile install nixpkgs#nix-eval-jobs

      - name: Generate Matrix with nix-eval-jobs
        id: set-matrix
        run: |
          set -Eeu

          matrix=$(nix-eval-jobs --flake ".#packages" \
            --check-cache-status \
            --force-recurse \
            --gc-roots-dir /tmp/gcroot \
            --option substituters "https://${{ env.CACHE_NAME }}.cachix.org https://cache.nixos.org" | \
            jq -sc 'map(select(.cacheStatus == "notBuilt")) |
              map({
                package: .attrPath[-1],
                attr: .attr,
                cacheStatus: .cacheStatus,
                isCached: .isCached,
                system: .system,
                runner: (if .system == "x86_64-linux" then "ubuntu-latest"
                        elif .system == "aarch64-linux" then "ubuntu-24.04-arm"
                        elif .system == "x86_64-darwin" then "ubuntu-latest"
                        else .system end)
              }) | {include: .}')

          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"
          echo "$matrix"

  build-packages:
    name: Build package ${{ matrix.package }}
    needs: generate-matrix
    if: ${{ needs.generate-matrix.outputs.matrix != '' && needs.generate-matrix.outputs.matrix != '{"include":[]}' }}
    runs-on: ${{ matrix.runner }}
    continue-on-error: true
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Nix with caching
        uses: ./.github/actions/setup-nix
        with:
          cachix-cache: ${{ env.CACHE_NAME }}
          cachix-token: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          skip-cache: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork }}
          skip-push: true

      - name: Build package
        id: build
        uses: ./.github/actions/nix-build
        with:
          target: ${{ matrix.package }}
          build-type: package
          output-link: result

      - name: Push to cachix
        run: |
          cachix push ${{ env.CACHE_NAME }} result

      - name: Post build comment
        if: ${{ always() && github.event_name == 'pull_request' }}
        uses: ./.github/actions/post-build-comment
        with:
          build-type: package
          build-name: ${{ matrix.package }}
          build-status: ${{ steps.build.outcome }}
          flake-target: ${{ matrix.package }}
          error-log: ${{ steps.build.outputs.error-log }}
          pr-number: ${{ github.event.pull_request.number }}
