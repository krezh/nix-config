---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Build Hosts

on:
  workflow_dispatch:
  pull_request:
    branches: ["main"]
    paths: &paths
      - "hosts/**"
      - "home/**"
      - "flake.nix"
      - "flake.lock"
      - "**.nix"
      - "!pkgs/**"
  push:
    branches: ["main"]
    paths: *paths

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Hosts
    runs-on: nix-config-runner
    if: ${{ github.event.pull_request.draft == false }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup SSH for remote builders
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.REMOTE_BUILDERS_SSH_KEY }}" > ~/.ssh/nix-builder-key
          chmod 600 ~/.ssh/nix-builder-key
          cat >> ~/.ssh/config <<EOF
          Host *
            StrictHostKeyChecking accept-new
            IdentityFile ~/.ssh/nix-builder-key
          EOF
          chmod 600 ~/.ssh/config

      - name: Install Nix
        uses: cachix/install-nix-action@0b0e072294b088b73964f1d72dfdac0951439dbd # v31.8.4
        with:
          extra_nix_config: |
            accept-flake-config = true
            always-allow-substitutes = true
            builders-use-substitutes = true
            experimental-features = nix-command flakes cgroups
            max-jobs = 0
            builders = @${{ github.workspace }}/.github/nix-builders.conf

      - name: Setup Attic cache
        if: ${{ !(github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork) }}
        uses: ryanccn/attic-action@7fbafba3978e86e585cb68a82c08b30f3672b62d # v0.4.0
        with:
          endpoint: ${{ secrets.ATTIC_ENDPOINT }}
          cache: ${{ secrets.ATTIC_CACHE }}
          token: ${{ secrets.ATTIC_TOKEN }}
          skip-push: true

      - name: Build all hosts
        id: build
        run: |
          nix run nixpkgs#nix-eval-jobs -- \
            --flake '.#hosts' \
            --check-cache-status | \
          jq -r '.neededBuilds[]' | \
          sort -u | \
          xargs -P 3 -I {} nix build --print-build-logs --out-link result "{}^*"

      - name: Push to Attic
        if: ${{ success() && !(github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork) }}
        run: |
          attic push ${{ secrets.ATTIC_CACHE }} result
