---
name: Build Nix systems
on:
  pull_request:
    paths-ignore: ["pkgs/**", ".github/**"]
  workflow_dispatch:
  workflow_call:
  push:
    branches: ["main"]
    paths:
      - "**.nix"
      - "flake.lock"
      - "modules/**"
      - "hosts/**"
permissions:
  id-token: "write"
  contents: "read"
concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true
env:
  CACHE_NAME: krezh
  NIX_CONFIG: |
    accept-flake-config = true
    always-allow-substitutes = true
    builders-use-substitutes = true

jobs:
  build-systems:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: ${{ github.event_name == 'pull_request' && 2 || 1 }}

      - name: Nothing but Nix
        uses: wimpysworld/nothing-but-nix@6af122a9403f936ef689e44cc013ae3f3e2f1c3b # v6
        with:
          hatchet-protocol: "cleave"
          witness-carnage: false
          nix-permission-edict: true

      - name: Install Nix
        uses: nixbuild/nix-quick-install-action@2c9db80fb984ceb1bcaa77cdda3fdf8cfba92035 # v34
        with:
          nix_conf: ${{ env.NIX_CONFIG }}

      - uses: nix-community/cache-nix-action@135667ec418502fa5a3598af6fb9eb733888ce6a # v6.1.3
        id: cache
        with:
          primary-key: nix-flake-inputs-${{ hashFiles('**/*.nix', '**/flake.lock') }}
          restore-prefixes-first-match: nix-flake-inputs-
          gc-max-store-size-linux: 1G
          purge: true
          purge-prefixes: nix-flake-inputs-
          purge-created: 0
          purge-last-accessed: 0
          purge-primary-key: never

      - run: nix build .#gc-keep # this keeps stuffs from getting garbage collected
        if: steps.cache.outputs.hit-primary-key != 'true'

      - name: Setup Cachix
        uses: cachix/cachix-action@0fc020193b5a1fa3ac4575aa3a7d3aa6a35435ad # v16
        if: ${{ github.event_name != 'pull_request' || !github.event.pull_request.head.repo.fork }}
        with:
          name: ${{ env.CACHE_NAME }}
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          skipPush: true

      - name: Setup Attic
        uses: ryanccn/attic-action@7fbafba3978e86e585cb68a82c08b30f3672b62d # v0.4.0
        if: ${{ github.event_name != 'pull_request' || !github.event.pull_request.head.repo.fork }}
        with:
          endpoint: ${{ secrets.ATTIC_ENDPOINT }}
          cache: ${{ secrets.ATTIC_CACHE }}
          token: ${{ secrets.ATTIC_TOKEN }}
          skip-push: true

      - name: Install nix-fast-build
        run: nix profile install github:Mic92/nix-fast-build

      - name: Get buildable checks
        id: get-checks
        run: |
          available_checks=$(nix eval --json '.#checks.x86_64-linux' --apply 'builtins.attrNames' | jq -r 'join(" ")')
          echo "checks=$available_checks" >> $GITHUB_OUTPUT

      - name: Get Nix settings from flake
        id: get-nix-settings
        run: |
          nix eval --json .#nixosConfigurations.thor.config.nix.settings > nix-settings.json
          substituters=$(jq -r '.substituters | join(" ")' nix-settings.json)
          keys=$(jq -r '.["trusted-public-keys"] | join(" ")' nix-settings.json)
          echo "substituters=$substituters" >> $GITHUB_OUTPUT
          echo "keys=$keys" >> $GITHUB_OUTPUT

      - name: Build systems
        id: build
        run: |
          if nix-fast-build \
            --flake ".#checks" \
            --no-nom \
            --skip-cached \
            --result-file build-results.json \
            --result-format json \
            --option substituters "${{ steps.get-nix-settings.outputs.substituters }}" \
            --option trusted-public-keys "${{ steps.get-nix-settings.outputs.keys }}"; then
            echo "build_success=true" >> $GITHUB_OUTPUT
          else
            echo "build_success=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate build summary
        if: always()
        run: |
          echo "# ðŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.build.outputs.build_success }}" == "true" ]]; then
            echo "## âœ… All builds succeeded!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Some builds failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Count results from JSON
          if [[ -f "build-results.json" ]]; then
            total_builds=$(jq '[.results[] | select(.type == "BUILD")] | length' build-results.json)
            successful_builds=$(jq '[.results[] | select(.type == "BUILD" and .success == true)] | length' build-results.json)
            failed_builds=$(jq '[.results[] | select(.type == "BUILD" and .success == false)] | length' build-results.json)

            echo "### ðŸ“Š Build Statistics" >> $GITHUB_STEP_SUMMARY
            echo "- **Total builds:** $total_builds" >> $GITHUB_STEP_SUMMARY
            echo "- **Successful:** $successful_builds" >> $GITHUB_STEP_SUMMARY
            echo "- **Failed:** $failed_builds" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # List what was built
            echo "### ðŸ“¦ Items Built" >> $GITHUB_STEP_SUMMARY
            jq -r '.results[] | select(.type == "BUILD") | "- " + .attr + (if .success then " âœ…" else " âŒ" end)' build-results.json >> $GITHUB_STEP_SUMMARY
          fi

      - name: Push to caches
        if: steps.build.outputs.build_success == 'true' && (github.event_name != 'pull_request' || !github.event.pull_request.head.repo.fork)
        continue-on-error: true
        run: |
          # Get store paths from result symlinks
          store_paths=""
          for result in result*; do
            if [[ -L "$result" ]]; then
              store_path=$(readlink "$result")
              if [[ -n "$store_path" ]]; then
                store_paths="$store_paths $store_path"
              fi
            fi
          done

          if [[ -n "$store_paths" ]]; then
            # Push to cachix
            if [[ -n "${{ env.CACHE_NAME }}" ]]; then
              echo "Pushing to cachix: ${{ env.CACHE_NAME }}"
              for path in $store_paths; do
                cachix push "${{ env.CACHE_NAME }}" "$path" &
              done
            fi

            # Push to attic
            if [[ -n "${{ secrets.ATTIC_CACHE }}" ]]; then
              echo "Pushing to attic: ${{ secrets.ATTIC_CACHE }}"
              for path in $store_paths; do
                attic push "${{ secrets.ATTIC_CACHE }}" "$path" &
              done
            fi

            # Wait for all pushes to complete
            wait

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¤ Cache Status" >> $GITHUB_STEP_SUMMARY
            if [[ -n "${{ env.CACHE_NAME }}" ]]; then
              echo "- **Cachix:** Pushed to ${{ env.CACHE_NAME }} âœ…" >> $GITHUB_STEP_SUMMARY
            fi
            if [[ -n "${{ secrets.ATTIC_CACHE }}" ]]; then
              echo "- **Attic:** Pushed to ${{ secrets.ATTIC_CACHE }} âœ…" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¤ Cache Status" >> $GITHUB_STEP_SUMMARY
            echo "- **Skipped:** No cache push (fork or cache failure)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if builds failed
        if: steps.build.outputs.build_success != 'true'
        run: exit 1
