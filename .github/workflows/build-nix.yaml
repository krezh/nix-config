name: Build and diff Nix systems
on:
  pull_request:
    paths-ignore: ["pkgs/**", ".github/**"]
  workflow_dispatch:
  workflow_call:
  push:
    branches: ["main"]
    paths: ["**.nix", "flake.nix"]
permissions:
  id-token: "write"
  contents: "read"
  pull-requests: "write"
concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true
env:
  EXCLUDED_HOSTS: '["nixos-livecd"]'
jobs:
  nix-build:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0

      - name: Nothing but Nix
        uses: wimpysworld/nothing-but-nix@6af122a9403f936ef689e44cc013ae3f3e2f1c3b # v6
        with:
          hatchet-protocol: "cleave"
          witness-carnage: false

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@90bb610b90bf290cad97484ba341453bd1cbefea # v19
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          extra-conf: |
            accept-flake-config = true
            always-allow-substitutes = true
            builders-use-substitutes = true

      - name: Check Flake Inputs
        uses: DeterminateSystems/flake-checker-action@3164002371bc90729c68af0e24d5aacf20d7c9f6 # v12

      - name: Setup Cachix
        uses: cachix/cachix-action@0fc020193b5a1fa3ac4575aa3a7d3aa6a35435ad # v16
        if: ${{ !github.event.pull_request.head.repo.fork }}
        with:
          name: krezh
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      - name: Setup FlakeHub Cache
        uses: DeterminateSystems/flakehub-cache-action@134cf641155463d87d343c6cb2b7970089967b99 # v2

      - name: Install nix-fast-build and nvd
        run: |
          nix profile install nixpkgs#nix-fast-build
          nix profile install nixpkgs#nvd

      - name: Build previous systems (PR only)
        if: ${{ github.ref_name != 'main' }}
        run: |
          nix-fast-build --skip-cached --no-nom "github:${{ github.repository }}#top"

      - name: Build new systems
        run: |
          nix-fast-build --skip-cached --no-nom .#top

      - name: Generate diff report (PR only)
        if: ${{ github.ref_name != 'main' }}
        run: |
          echo "# Build Diff Report" > diff-report.md
          echo "" >> diff-report.md
          echo "Systems have been built with nix-fast-build. Individual system diffs would require additional setup to compare specific outputs." >> diff-report.md

      - name: Comment report in PR
        if: ${{ github.ref_name != 'main' && hashFiles('diff-report.md') != '' }}
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: "nix-build-diff"
          path: diff-report.md
