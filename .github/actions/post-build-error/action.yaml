---
name: "Post Build Error Comment"
description: "Posts build error logs to PR comments"
author: "krezh"

inputs:
  build-type:
    description: "Type of build (package, system, or iso)"
    required: true
  build-name:
    description: "Name of package or host"
    required: true
  flake-target:
    description: "Flake target that failed"
    required: true
  error-log:
    description: "Error log content"
    required: true
  build-duration:
    description: "Build duration in seconds (optional, for system builds)"
    required: false
    default: ""
  runner:
    description: "Runner type (optional, for system builds)"
    required: false
    default: ""
  pr-number:
    description: "PR number"
    required: true

runs:
  using: "composite"
  steps:
    - name: Format build duration
      id: format-duration
      shell: bash
      run: |
        duration_seconds=${{ inputs.build-duration }}
        if [ -z "$duration_seconds" ] || [ "$duration_seconds" = "0" ]; then
          echo "formatted=0s" >> $GITHUB_OUTPUT
        elif [ "$duration_seconds" -ge 3600 ]; then
          hours=$((duration_seconds / 3600))
          minutes=$(((duration_seconds % 3600) / 60))
          seconds=$((duration_seconds % 60))
          echo "formatted=${hours}h${minutes}m${seconds}s" >> $GITHUB_OUTPUT
        elif [ "$duration_seconds" -ge 60 ]; then
          minutes=$((duration_seconds / 60))
          seconds=$((duration_seconds % 60))
          echo "formatted=${minutes}m${seconds}s" >> $GITHUB_OUTPUT
        else
          echo "formatted=${duration_seconds}s" >> $GITHUB_OUTPUT
        fi

    - name: Comment build errors on PR
      uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
      with:
        header: "${{ inputs.build-type == 'package' && 'Package' || 'System' }} Build: ${{ inputs.build-name }}"
        message: |
          ## âŒ ${{ inputs.build-type == 'package' && 'Package' || 'System' }} Build Failed: `${{ inputs.build-name }}`

          | Property | Value |
          |----------|-------|
          | **${{ inputs.build-type == 'package' && 'Package' || 'Host' }}** | `${{ inputs.build-name }}` |${{ inputs.runner && format('
          | **Runner** | `{0}` |', inputs.runner) || '' }}
          | **Time to Failure** | ${{ steps.format-duration.outputs.formatted }} |

          ### ğŸ› ï¸ Debugging

          **Flake Target:** `${{ inputs.flake-target }}`

          **Reproduce locally:**
          ```bash
          nix build github:${{ github.repository }}/pull/${{ inputs.pr-number }}/head#${{ inputs.flake-target }}
          ```

          ### Build Errors (last 100 error lines)

          <details>
          <summary>Click to expand error log</summary>

          ```
          ${{ inputs.error-log }}
          ```

          </details>

          ---
          <sub>ğŸ¤– [View full logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>
