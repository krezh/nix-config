name: Setup Nix with Caching
description: Install Nix and configure Cachix + Attic caches
inputs:
  caches:
    description: Enable cache setup (Cachix + Attic)
    required: false
    default: "true"
  cachix-auth-token:
    description: Cachix authentication token
    required: false
  attic-endpoint:
    description: Attic cache endpoint
    required: false
  attic-cache:
    description: Attic cache name
    required: false
  attic-token:
    description: Attic authentication token
    required: false
  cache-name:
    description: Cachix cache name
    required: false
    default: krezh
  skip-cache:
    description: Skip cache setup (for forks/external PRs)
    required: false
    default: "false"
runs:
  using: composite
  steps:
    - name: Install Nix
      uses: nixbuild/nix-quick-install-action@2c9db80fb984ceb1bcaa77cdda3fdf8cfba92035 # v34
      with:
        nix_conf: |
          accept-flake-config = true
          always-allow-substitutes = true
          builders-use-substitutes = true

    - name: Setup Cachix
      if: inputs.caches == 'true' && inputs.skip-cache != 'true'
      uses: cachix/cachix-action@0fc020193b5a1fa3ac4575aa3a7d3aa6a35435ad # v16
      with:
        name: ${{ inputs.cache-name }}
        authToken: ${{ inputs.cachix-auth-token }}

    - name: Setup Attic
      if: inputs.caches == 'true' && inputs.skip-cache != 'true'
      uses: ryanccn/attic-action@7fbafba3978e86e585cb68a82c08b30f3672b62d # v0.4.0
      with:
        endpoint: ${{ inputs.attic-endpoint }}
        cache: ${{ inputs.attic-cache }}
        token: ${{ inputs.attic-token }}
